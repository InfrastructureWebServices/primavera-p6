<!DOCTYPE html>
<html>

<head>
    <title>Primavera P6 Viewer</title>

    <script src="{{base_url}}public/modules/ibm-gantt-chart-0.5.29/ibm-gantt-chart.js" type="text/javascript"></script>
    <link href="{{base_url}}public/modules/ibm-gantt-chart-0.5.29/ibm-gantt-chart.css" rel="stylesheet">

    <!--  Page styles  -->
    <style>
        html {
            height: 100%;
        }

        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #gantt {
            height: 100%;
            width: 100%;
        }

        .dataTables_wrapper {
            min-height: 100%;
        }
    </style>
</head>

<body>
    <div id="gantt">
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var config = {
                data: {
                    all: {
                        url: "./get?type=gantt-chart",
                        success: function (data) {
                            return data; // Return the processed model
                        }
                    },
                    resources: {
                        data: function (data) {
                            return [data];
                        },
                        parent: 'parent',
                        name: 'actv_code_name',
                        id: 'actv_code_id',
                    },
                    reservations: {
                        data: function (data) {
                            return [];
                        },
                        activity: 'activity',
                        resource: 'resource',
                    },
                    activities: {
                        data: function (data) {
                            value = data.activities;
                            return value;
                        },
                        start: function (activity) {
                            if (activity.task_id) {
                                value = activity.target_start_date;
                                value = new Date(value).getTime();
                                return value;
                            }
                            return null;
                        },
                        end: function (activity) {
                            if (activity.task_id) {
                                value = activity.target_end_date;
                                value = new Date(value).getTime();
                                return value;
                            }
                            return null;
                        },
                        parent: function (activity) {
                            if (activity.parent) { 
                                return activity,parent;
                            } 
                            return null;
                        },
                        name: function (activity) {
                            if (activity.task_id) {
                                value = activity.task_name;
                            } else {
                                value = activity.wbs_name;
                            }
                            return value;
                        },
                        id: function (activity) {
                            if (activity.task_id) {
                                value = activity.task_id;
                            } else {
                                value = activity.wbs_id;
                            }
                            return value;
                        }
                    },
                    constraints: {
                        data: function (data) {
                            return [];
                        },
                        from: 'from',
                        to: 'to',
                        type: 'type',
                    }
                },
                type: Gantt.type.ACTIVITY_CHART,
                toolbar: [
                    'title',
                    'search',
                    'separator',
                    'mini',
                    'separator',
                    'fitToContent',
                    'zoomIn',
                    'zoomOut',
                    'separator',
                    {
                        type: 'select',
                        text: 'Filter WBS',
                        options: [
                            { value: 'false', text: 'No' },
                            { value: 'true', text: 'Yes' },
                        ],
                        onchange(value, ctx) {
                            const gantt = ctx.gantt;
                            if (gantt.WBSFilter) {
                                gantt.removeFilter(gantt.WBSFilter);
                            }
                            if (value && value !== 'false') {
                                gantt.WBSFilter = gantt.addFilter(
                                    function (obj) {
                                        var is_wbs = obj.getData().hasOwnProperty('wbs_id');
                                        return is_wbs;
                                    },
                                    true /* filter rows */,
                                    true /* filter activities */
                                );
                            }
                        },
                    },
                ],
                title: "{{project.proj_short_name}}",
            };

            globalThis.gantt = new Gantt('gantt', config);
        });


    </script>
</body>

</html>